<!DOCTYPE html>
<html>

<head>
    <script src="./dist/squirrelly.dev.js"></script>
</head>

<body>
    <div id="result1"></div>
    <p>--------------------</p>
    <div id="functionResult"></div>

<textarea oninput="comp()" id="input" style="width: 200px; height: 200px;">
Hi
{{log("hey fellas")/}}
{{htmlstuff}}
{{foreach(options.obj)}}
Reversed value: {{@this|reverse}}, Key: {{@key}}
{{if(@key==="thirdchild")}}
{{each(options.obj[@key])}}
Salutations. Index: {{@index}}
Old key: {{@../key}}
{{/each}}
{{/if}}
{{/foreach}}

{{ben()}}
{{#gubler}}
Hey
{{#pineapple}}
HI
{{/ben}}

</textarea>
    <div id="output"></div>
    <script>
        Sqrl.defineFilter("reverse", function (str) {
            var out = ''
            for (var i = str.length - 1; i >= 0; i--) {
                out += str.charAt(i)
            }
            return out || str
        })

        Sqrl.defineHelper("ben", function(args, content, blocks, options) {
            return "The content of gubler: " + blocks.gubler() + ", the content of pineapple: " + blocks.pineapple()
        })

        function escape (str) {
            var escMap = {
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#39;",
            "/": "&#x2F;",
            "`": "&#x60;",
            "=": "&#x3D;"
            }
            //To deal with XSS. Based on Escape implementations of Mustache.JS and Marko, then customized.
            function replaceChar(s) {
                return escMap[s]
            }
            var newStr = String(str)
            if (/[&<>"'`=\/]/.test(newStr)) {
                return newStr.replace(/[&<>"'`=\/]/g, replaceChar)
            } else {
                return newStr
            }
       }

        Sqrl.defaultFilters.reverse = false
        Sqrl.autoEscape = true


        function comp() {
            console.clear()
            console.time("comp")
            let newtemplatefunction = Sqrl.Precompile(document.getElementById("input").value)

            console.log("Function returned by comp: ")
            console.log(newtemplatefunction.toString())
            console.log("typeof newtemplatefunction: " + typeof newtemplatefunction)
            let result = newtemplatefunction({
                htmlstuff: "<script>alert('hey')<\/script><p>alert('hey')</p><p>alert('hey')</p><p>alert('hey')</p>",
                arr: ["Hey", "<p>Malicious XSS</p>", "Hey", 3, 3*4],
                obj: {
                    firstchild: "HI",
                    secondchild: "HEY",
                    thirdchild: [3, 6, 3, 2, 5, 4]
                }
            }, Sqrl)
            console.log("result: " + result)
            document.getElementById("result1").innerHTML = result
            console.timeEnd("comp")
            document.getElementById("functionResult").innerHTML = escape(newtemplatefunction)

        }
        comp()
    </script>
</body>

</html>